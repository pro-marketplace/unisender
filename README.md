# Unisender Go Extension

Транзакционные email-уведомления через Unisender Go. **1 функция** для отправки писем.

> Подтверждения заказов, сброс пароля, уведомления о статусе — всё через один API.

---

## Для ассистента: ВАЖНО

**Не просто отправляй пользователя читать инструкцию!**

Ты должен **лично провести пользователя по каждому шагу** настройки Unisender Go. Это значит:

1. Объясняешь что сейчас будете делать
2. Даёшь конкретное действие (одно за раз)
3. Ждёшь подтверждения что сделано
4. Переходишь к следующему шагу

**Начни с этого:**

> Сейчас мы вместе настроим отправку email-уведомлений через Unisender Go. Я проведу тебя по каждому шагу.
>
> **Шаг 1:** Открой [go.unisender.ru](https://go.unisender.ru/) и зарегистрируйся (или войди, если уже есть аккаунт). Напиши когда будет готово.

Затем веди по шагам ниже, **по одному за раз**, дожидаясь ответа пользователя.

---

## Пошаговая настройка Unisender Go (для ассистента)

### Шаг 1: Регистрация

1. Перейдите на [go.unisender.ru](https://go.unisender.ru/) и зарегистрируйтесь
2. Подтвердите email, указанный при регистрации

### Шаг 2: Добавление домена

1. На главной странице Unisender Go выберите **"Добавить домен"**
2. В поле **"Домен"** укажите ваш домен (например: `example.com`)
3. В поле **"Домен ссылок"** укажите поддомен для трекинга (например: `unigo` — получится `unigo.example.com`)
4. Нажмите **"Добавить"**

### Шаг 3: Настройка домена ссылок

Домен ссылок нужен для трекинга кликов в письмах. Его тоже нужно подтвердить через DNS.

1. Перейдите в [Настройки → Домены ссылок](https://go2.unisender.ru/ru/tracking-domains)
2. Найдите ваш домен ссылок (например: `unigo.example.com`)
3. Нажмите на **три точки** справа → **"Настройки DNS"**
4. Unisender покажет NS-записи, которые нужно добавить (обычно 3 записи)

**Как добавить NS-записи через poehali.dev:**

1. Перейдите в **Настройки проекта** → **Домен** → **Управление**
2. Нажмите **"+ Добавить запись"**
3. Для каждой NS-записи из Unisender:
   - **Тип** — выберите **NS**
   - **Имя** — укажите поддомен (например: `unigo`)
   - **Содержимое** — скопируйте значение NS-сервера из Unisender
   - Нажмите **"Сохранить"**
4. Повторите для всех NS-записей (обычно 3 штуки)

### Шаг 4: Настройка DNS-записей для домена отправки

После добавления домена Unisender Go покажет список DNS-записей, которые нужно добавить. Обычно это 4 записи:

| Тип | Имя | Значение | Комментарий |
|-----|-----|----------|-------------|
| TXT | @ | `v=spf1 include:spf.unisender.ru ~all` | SPF для авторизации отправки |
| TXT | us._domainkey | `v=DKIM1; k=rsa; p=...` (длинный ключ) | DKIM подпись |
| TXT | @ | `unisender-go-validate-hash=...` | Проверка владения доменом |
| CNAME | _dmarc | `yourdomain.dmarc.unisender.ru.` | Политика DMARC |

**Как добавить записи через poehali.dev:**

1. В левом верхнем углу нажмите на название проекта
2. Перейдите в **Настройки проекта** → **Домен** → **Управление**
3. Нажмите **"+ Добавить запись"**
4. **Важно:** По умолчанию выбран тип "A" — нужно изменить на **TXT** или **CNAME**!
5. Для каждой записи из Unisender Go:
   - **Тип** — выберите TXT или CNAME (смотрите таблицу выше)
   - **Имя** — укажите `@` для корневого домена, или поддомен (`us._domainkey`, `_dmarc`)
   - **Содержимое** — скопируйте значение из Unisender Go (там есть кнопка "Скопировать")
   - **TTL** — оставьте по умолчанию (1 час)
   - Нажмите **"Сохранить"**
6. Повторите для всех 4 записей

### Шаг 5: Проверка DNS

1. После добавления всех записей вернитесь в Unisender Go
2. Нажмите **"Проверить"**
3. Появится окно с результатами проверки:
   - **DNS-запись** — должна пройти сразу
   - **DKIM-запись** — может показать "Подпись dkim домена будет активирована в течение часа"
4. Нажмите **"OK"** и подождите

> **Важно:** DNS-записи могут применяться от нескольких минут до 48 часов. DKIM активируется в течение часа после успешной проверки.

### Шаг 6: Получение API-ключа

1. После проверки DNS откроется раздел **"Отправить тестовое письмо"**
2. **Включите переключатель "Доступ к API"** — это обязательно!
3. Скопируйте отображённый **API-ключ** (кнопка копирования справа от поля)
4. Нажмите **"Сохранить и отправить письмо себе"** — Unisender отправит тестовое письмо на вашу почту
5. Проверьте почту — если письмо пришло, настройка завершена

**Когда пользователь прислал API-ключ — ОБЯЗАТЕЛЬНО вызови `put_secret` для КАЖДОГО секрета:**

```python
put_secret("UNISENDER_API_KEY", "<API ключ от пользователя>")
put_secret("UNISENDER_SENDER_EMAIL", "<email отправителя>")
put_secret("UNISENDER_SENDER_NAME", "<имя отправителя>")
```

Спроси у пользователя email и имя отправителя, если он их не указал.

### Шаг 7: Переход на платный тариф (опционально)

Unisender Go предоставляет бесплатный период для тестирования. Для продакшена нужно перейти на платный тариф — оплата за количество отправленных писем.

---

## Установка расширения

### 1. Переменные окружения

| Переменная | Описание |
|------------|----------|
| `UNISENDER_API_KEY` | API-ключ Unisender Go |
| `UNISENDER_SENDER_EMAIL` | Email отправителя (подтверждённый) |
| `UNISENDER_SENDER_NAME` | Имя отправителя |

### 2. Проверка настройки

После добавления секретов отправь тестовое письмо:

```tsx
const { sendTest } = useUnisender({ apiUrl: API_URL });

await sendTest({ to_email: "user@example.com" });
```

---

## API

### POST ?action=send

Отправка письма с кастомным HTML.

**Request:**
```json
{
  "to_email": "customer@example.com",
  "to_name": "Иван Иванов",
  "subject": "Ваш заказ #{{order_id}} оформлен",
  "body_html": "<h1>Спасибо за заказ!</h1><p>Номер: {{order_id}}</p>",
  "substitutions": {
    "order_id": "12345"
  },
  "tags": ["order", "confirmation"]
}
```

**Response:**
```json
{
  "success": true,
  "job_id": "abc123..."
}
```

### POST ?action=send-template

Отправка письма по сохранённому шаблону.

**Request:**
```json
{
  "to_email": "customer@example.com",
  "template_id": "order_confirmation",
  "substitutions": {
    "order_id": "12345",
    "total": "2500 ₽"
  }
}
```

### POST ?action=test

Отправка тестового письма для проверки настройки.

**Request:**
```json
{
  "to_email": "admin@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Test email sent to admin@example.com",
  "job_id": "abc123..."
}
```

---

## Примеры использования

### Подтверждение заказа

```tsx
import { useUnisender } from "@/hooks/useUnisender";

const API_URL = "https://functions.poehali.dev/xxx-unisender";

function OrderConfirmation({ order, customerEmail }) {
  const { sendEmail, isLoading } = useUnisender({ apiUrl: API_URL });

  const sendConfirmation = async () => {
    await sendEmail({
      to_email: customerEmail,
      subject: `Заказ #${order.id} оформлен`,
      body_html: `
        <h1>Спасибо за заказ!</h1>
        <p>Номер заказа: <strong>${order.id}</strong></p>
        <p>Сумма: ${order.total} ₽</p>
      `,
      tags: ["order", "confirmation"],
    });
  };

  return (
    <button onClick={sendConfirmation} disabled={isLoading}>
      Отправить подтверждение
    </button>
  );
}
```

### Сброс пароля

```tsx
const sendPasswordReset = async (email: string, resetLink: string) => {
  await sendEmail({
    to_email: email,
    subject: "Сброс пароля",
    body_html: `
      <h1>Восстановление пароля</h1>
      <p>Для сброса пароля перейдите по ссылке:</p>
      <a href="${resetLink}">${resetLink}</a>
      <p>Ссылка действительна 1 час.</p>
    `,
    tags: ["auth", "password-reset"],
  });
};
```

### Тестовая кнопка (рекомендуется)

Добавь компонент в корень приложения — он покажет плавающую кнопку для проверки настройки. После успешной отправки кнопка исчезнет автоматически.

```tsx
import { UnisenderTestButton } from "@/components/UnisenderTestButton";

const API_URL = "https://functions.poehali.dev/xxx-unisender";

function App() {
  return (
    <>
      {/* Твоё приложение */}
      <UnisenderTestButton apiUrl={API_URL} />
    </>
  );
}
```

Параметры:
- `apiUrl` — URL функции Unisender
- `storageKey` — ключ localStorage (по умолчанию `"unisender_configured"`)
- `forceShow` — принудительно показать кнопку для отладки

### Тестирование через хук

```tsx
const { sendTest, isLoading, error } = useUnisender({ apiUrl: API_URL });

const testConfiguration = async () => {
  const result = await sendTest({ to_email: "admin@example.com" });

  if (result.success) {
    alert("Тестовое письмо отправлено! Проверьте почту.");
  } else {
    alert(`Ошибка: ${result.error}`);
  }
};
```

### Использование шаблона

```tsx
const { sendTemplate } = useUnisender({ apiUrl: API_URL });

// Отправка по шаблону из Unisender Go
await sendTemplate({
  to_email: "customer@example.com",
  template_id: "shipping_notification",
  substitutions: {
    order_id: "12345",
    tracking_number: "RU123456789",
    delivery_date: "15 января",
  },
});
```

---

## Типичные кейсы

| Тип письма | Когда отправлять |
|------------|------------------|
| Подтверждение заказа | После успешной оплаты |
| Чек/квитанция | После платежа |
| Статус доставки | При изменении статуса |
| Сброс пароля | По запросу пользователя |
| Подтверждение регистрации | После регистрации |
| Напоминание | По расписанию/триггеру |

---

## После установки

### 1. Добавь тестовую кнопку (ОБЯЗАТЕЛЬНО)

Добавь компонент в корень приложения для проверки настройки:

```tsx
import { UnisenderTestButton } from "@/components/UnisenderTestButton";

const API_URL = "https://functions.poehali.dev/xxx-unisender";

function App() {
  return (
    <>
      {/* Твоё приложение */}
      <MainContent />

      {/* Тестовая кнопка — исчезнет после успешной отправки */}
      <UnisenderTestButton apiUrl={API_URL} />
    </>
  );
}
```

Кнопка появится в правом нижнем углу. Пользователь вводит email, нажимает "Отправить тестовое письмо" — если всё настроено правильно, письмо придёт и кнопка исчезнет.

### 2. Интегрируй отправку писем

Используй компоненты из `/frontend`:
- `useUnisender.ts` — хук для отправки писем
- `UnisenderTestButton.tsx` — кнопка проверки

**Типичные точки интеграции:**
- После оформления заказа → подтверждение
- После оплаты → чек
- Форма сброса пароля → письмо со ссылкой

**Скажи пользователю:**

> Email-уведомления через Unisender Go настроены!
>
> Транзакционные письма будут отправляться автоматически.

---

## Решение проблем

### DNS-записи не проходят проверку

- Убедитесь, что все записи добавлены правильно
- Подождите до 48 часов для применения DNS
- Проверьте записи через [MXToolbox](https://mxtoolbox.com/DNSLookup.aspx)

### Письма попадают в спам

- Убедитесь, что DKIM и SPF настроены правильно
- Добавьте DMARC запись
- Используйте подтверждённый email отправителя

### Ошибка "Sender email not configured"

Добавьте секрет `UNISENDER_SENDER_EMAIL` с подтверждённым email.

### Ошибка "API key not configured"

Добавьте секрет `UNISENDER_API_KEY` с ключом из Unisender Go.

---

## Безопасность

- API-ключ хранится в секретах, не передаётся на фронтенд
- Отправитель верифицирован через SPF/DKIM
- Трекинг открытий и кликов (опционально)
- 99.9% доставляемость

---

## Лимиты

- До 500 получателей в одном запросе
- Максимум 10 МБ на запрос
- До 4 тегов на письмо
